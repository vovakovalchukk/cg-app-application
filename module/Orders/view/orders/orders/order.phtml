<?php
use CG\Order\Shared\Tracking\Status as OrderTrackingStatus;
?>
<?php $this->inlineScript()->captureStart(); ?>
    $('form').submit(function() {
        return false;
    });
    require.config({
        paths: {
            'Orders': "<?= $this->basePath() . Orders\Module::PUBLIC_FOLDER . 'js';?>",
            'Common': '<?= $this->basePath() ?>/cg-built/common/js/Common'
        }
    });
require([
        'react',
        'react-dom',
        'Common/Components/Notes/Root',
        "orderDetails/OrderDetailsSidebar",
        "address/Address",
        "alert/Alert",
        "orderDetails/OrderDetailsPage",
        "tracking/orderTracking",
        "Clipboard"
    ],
    function(React, ReactDOM, NoteComponent, OrderDetailsSidebar, Address, Alert, OrderDetailsPage, OrderTracking, Clipboard) {
        //References to n need to be migrated, it is the notification library
        var existingNotes = <?= $existingNotes ?>;
        var orderId = '<?= $order->getId() ?>';
        ReactDOM.render(React.createElement(NoteComponent, { author: usersName, orderId: orderId, existingNotes: existingNotes }), document.getElementById('order-notes'));
        var sidebar = new OrderDetailsSidebar();
        var address = new Address(n, '#addressInformation');
        var orderTracking = new OrderTracking(n, '#trackingInformation');
        var alert = new Alert(n, '#alert');
        var orderDetailsPage = new OrderDetailsPage(sidebar, address, alert, orderTracking);

        var billingClipboard = new Clipboard(
            '#copy-billing-address',
            $('#billing-information').find('label input.copy-address')
        );
        <?php if (!$order->getFulfilmentAddress()): ?>
        var shippingClipboard = new Clipboard(
            '#copy-shipping-address',
            $('#shipping-information').find('label input.copy-address')
        );
        <?php else: ?>
        var fulfilmentClipboard = new Clipboard(
            '#copy-shipping-address',
            $('#fulfilment-information')
        );
        <?php endif; ?>

});
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->placeholder('#sidebar')->set($this->sidebar); ?>
<?php $this->headLink()->appendStylesheet($this->basePath() .'/cg-built/common/css/default.css', ['screen', 'print']) ?>

<div class="bulk-actions-section clearfix section-seperator">
    <div class="orderid-logo-holder">
        <?= $this->accountDetails ?>
        <?= $this->orderDetails ?>
        <?= $this->status ?>
    </div>
    <div class="bulk-actions-holder">
      <?= $this->bulkActions ?>
    </div>
</div>

<div class="module clearfix section-seperator timeline" id="timeline">
    <?= $this->timelineBoxes; ?>
</div>

<div class="module clearfix section-separator" id="order-alert">
    <?= $this->orderAlert; ?>
</div>
<div class="module clearfix section-separator" id="order-buyer-message">
    <?= $this->buyerMessage ?>
</div>
<div class="module clearfix section-separator" id="address-information">
    <?= $this->addressInformation ?>
</div>
<?php if ($this->editable): ?>
<div class="module clearfix section-separator" id="tracking-information">
    <span class="heading-large heading-spacing"><?= $this->translate('Shipping'); ?></span>
    <?= $this->labelDetails; ?>
    <form id="trackingInformation"
          data-url="<?= $this->url('Orders/order/tracking', array('order' => $order->getId())); ?>"
          data-actionMessage="<?= $this->translate('Updating tracking info'); ?>"
          data-confirmMessage="<?= $this->translate('You have used this tracking number before, you may have an error when dispatching. Do you wish to continue using this tracking number?'); ?>"
          data-successMessage="<?= $this->translate('Tracking info updated'); ?>"
        >
        <div class="half">
        <label>
            <span class="inputbox-label"><?= $this->translate('Carrier'); ?></span>
            <div class="order-inputbox-holder">
                <?= $this->carrierSelect ?>
            </div>
        </label>
        <label>
            <span class="inputbox-label"><?= $this->translate('Tracking Number'); ?></span>
            <div class="order-inputbox-holder">
                <input class="inputbox" id="trackingNumber" type="text" name="trackingNumber" value="<?= ($tracking) ? $tracking->getNumber() : ""; ?>">
            </div>
            <?php if ($tracking && $tracking->getStatus() == OrderTrackingStatus::ERROR): ?>
            <div class="sprite-alert-tri-28-black" title="There was a problem sending the tracking number to the channel" style="float: left; margin-left: 20px;"></div>
            <?php endif; ?>
        </label>
        <input type="hidden" value="<?= ($tracking) ? $tracking->getStoredETag() : ""; ?>" id="eTag" name="eTag"/>
        <div class="half" style="clear:both; padding-top:0px;">
            <div class="order-inputbox-holder">
                <input type="submit" name="save" class="button form-button tracking-button" value="<?= $this->translate('Save'); ?>">
            </div>
        </div>
        </div>
    </form>
</div>
<?php endif; ?>
<div id="product-payment-table" class="module clearfix section-separator">
    <span class="heading-large heading-spacing"><?= $this->translate('Product & Payment Information'); ?></span>
    <?php if(count($order->getItems())):?>
        <div id="products-table">
          <?= $this->productPaymentTable; ?>
        </div>
    <?php else: ?>
        <p><?= $this->translate('This order has no items'); ?></p>
    <?php endif;?>
    <table class="no-borders totals-table">
        <tr>
            <td class="leftcell" class="left">
                <?php if ($order->getPaymentMethod()): ?>
                    <strong><?= $this->translate('Paid Via'); ?>:</strong> <?= $order->getPaymentMethod() ?>
                <?php endif; ?>
            </td>
            <td class="midcell"><strong><?= $this->translate('Postage & Packing'); ?>:</strong></td>
            <td class="rightcell"><?= $this->currencyFormat($order->getShippingPrice(), $order->getCurrencyCode()); ?></td>
        </tr>
        <tr>
            <td class="leftcell"></td>
            <td class="midcell"><strong><?= $this->translate('Subtotal'); ?>:</strong></td>
            <td class="rightcell"><?= $this->currencyFormat($order->getSubtotal(), $order->getCurrencyCode()); ?></strong></td>
        </tr>
        <?php if ($rootOu->isVatRegistered()): ?>
        <tr>
            <td class="leftcell">
                <?php if ($order->getPaymentReference()): ?>
                    <?= $this->translate('Reference'); ?>: <strong><?= $order->getPaymentReference() ?></strong>
                <?php endif; ?>
            </td>
            <td class="midcell"><strong><?= $this->translate('VAT'); ?>:</strong></td>
            <td class="rightcell"><?= $this->currencyFormat($order->getTax(), $order->getCurrencyCode()); ?></strong></td>
        </tr>
        <?php endif; ?>
        <tr>
            <td class="leftcell"></td>
            <td class="midcell"><strong><?= $this->translate('Total'); ?>:</strong></td>
            <td class="rightcell"><?= $this->currencyFormat($order->getTotal(), $order->getCurrencyCode()); ?></strong></td>
        </tr>
    </table>
</div>
<div id="order-notes" class="module clearfix section-separator">
</div>
