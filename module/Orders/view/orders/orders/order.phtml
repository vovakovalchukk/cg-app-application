<?php $this->headScript()->appendFile($this->basePath() . CG_UI\Module::PUBLIC_FOLDER . 'js/mustache.js'); ?>
<?php $this->headScript()->appendFile($this->basePath() . CG_UI\Module::PUBLIC_FOLDER . 'js/cg-mustache.js'); ?>
<?php $this->inlineScript()->captureStart(); ?>
    $('form').submit(function() {
        return false;
    });
require([
        "note/NoteDomAccess",
        "note/Notes",
        "note/Note",
        "orderDetails/OrderDetailsSidebar",
        "address/Address",
        "alert/Alert",
        "orderDetails/OrderDetailsPage"
    ],
    function(NoteDomAccess, Notes, Note, OrderDetailsSidebar, Address, Alert, OrderDetailsPage) {
        //References to n need to be migrated, it is the notification library
        var noteDomAccess = new NoteDomAccess('#notes', '#note-input', CGMustache);
        var notes = new Notes(noteDomAccess, n, Note);
        var sidebar = new OrderDetailsSidebar();
        var address = new Address(n, '#addressInformation');
        var alert = new Alert(n, '#alert');
        var orderDetailsPage = new OrderDetailsPage(sidebar, address, notes, alert);
});
<?php $this->inlineScript()->captureEnd(); ?>
<?php $this->placeholder('#sidebar')->set($this->sidebar); ?>
<div class="module clearfix section-separator" id="timeline">
    <?= $this->timelineBoxes; ?>
    <div class="order-details-right">
        <div class="orderid-logo-holder">
            <span class="order-status-holder status <?= $order->getStatus(); ?>-bg"><?= $order->getStatus(); ?></span>
            <span class="logo-large <?=$order->getChannel()?>"></span>
            <span class="orderid"><strong><?= $this->translate('Order ID'); ?>: </strong><?= $order->getExternalId(); ?></span>
        </div>
    </div>
</div>

<div class="clearfix section-separator">
    <?= $this->bulkActions ?>
</div>
<div class="module clearfix section-separator" id="order-alert">
    <form class="single-row" id="alert" data-url="<?= $this->url('Orders/order/alert', array('order' => $order->getId())); ?>"
          data-actionMessage="<?= $this->translate('Saving alert'); ?>" data-successMessage="<?= $this->translate('Alert saved'); ?>">
        <label>
            <span class="sprite-alert-tri-28-black"></span>
            <span class="large-heading-left"><?= $this->translate('Order Alert'); ?>:</span>
            <?php
                $alerts = $order->getAlerts();
                $alerts->rewind();
                $alert = $alerts->current();
            ?>
            <div class="order-alert-inputholder">
                <input type="text" class="inputbox" name="" value="<?= ($alert) ? $alert->getAlert() : ""; ?>" id="input"/>
            </div>
            <input type="hidden" value="<?= ($alert) ? $alert->getETag() : ""; ?>" id="eTag"/>
            <div class="order-alert-button">
                <input type="submit" class="button inline alert-save" value="<?= $this->translate('Save Alert'); ?>"/>
            </div>
        </label>
    </form>
</div>
<div class="module clearfix section-separator" id="order-buyer-message">
    <form class="single-row">
        <label>
            <span class="sprite-user-28-black"></span>
            <span class="large-heading-left">Buyer Message:</span>
            <p class="buyer-message"><?= $order->getBuyerMessage() ?: $this->translate("There is no buyer message for this order"); ?></p>
        </label>
    </form>
</div>
<div class="module clearfix section-separator">
    <div id="detailsForm">
        <form id="addressInformation" data-url="<?= $this->url('Orders/order/address', array('order' => $order->getId())); ?>"
              data-actionMessage="<?= $this->translate('Updating address'); ?>" data-successMessage="<?= $this->translate('Address updated'); ?>">
            <input type="hidden" id="eTag" name="eTag" value="<?= $order->getUserChange() ? $order->getUserChange()->getEtag() : null; ?>">
            <div class="half" id="billing-information">
                <span class="heading-large heading-spacing"><?= $this->translate('Billing Information'); ?></span>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Buyer Name'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddressFullName" value="<?= $order->getCalculatedBillingAddressFullName(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Company Name'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddressCompanyName" value="<?= $order->getCalculatedBillingAddressCompanyName(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Address Line 1'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddress1" value="<?= $order->getCalculatedBillingAddress1(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Address Line 2'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddress2" value="<?= $order->getCalculatedBillingAddress2(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Address Line 3'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddress3" value="<?= $order->getCalculatedBillingAddress3(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('City'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddressCity" value="<?= $order->getCalculatedBillingAddressCity(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('County'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddressCounty" value="<?= $order->getCalculatedBillingAddressCounty(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Postcode'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddressPostcode" value="<?= $order->getCalculatedBillingAddressPostcode(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Country'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingAddressCountry" value="<?= $order->getCalculatedBillingAddressCountry(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Email'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingEmailAddress" value="<?= $order->getCalculatedBillingEmailAddress(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Telephone'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="billingPhoneNumber" value="<?= $order->getCalculatedBillingPhoneNumber(); ?>">
                    </div>
                </label>
            </div>
            <div class="half"  id="shipping-information">
                <span class="heading-large heading-spacing"><?= $this->translate('Shipping Information'); ?></span>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Recipient Name'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddressFullName" value="<?= $order->getCalculatedShippingAddressFullName(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Company Name'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddressCompanyName" value="<?= $order->getCalculatedShippingAddressCompanyName(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Address Line 1'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddress1" value="<?= $order->getCalculatedShippingAddress1(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Address Line 2'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddress2" value="<?= $order->getCalculatedShippingAddress2(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Address Line 3'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddress3" value="<?= $order->getCalculatedShippingAddress3(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('City'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddressCity" value="<?= $order->getCalculatedShippingAddressCity(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('County'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddressCounty" value="<?= $order->getCalculatedShippingAddressCounty(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Postcode'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddressPostcode" value="<?= $order->getCalculatedShippingAddressPostcode(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Country'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingAddressCountry" value="<?= $order->getCalculatedShippingAddressCountry(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Email'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingEmailAddress" value="<?= $order->getCalculatedShippingEmailAddress(); ?>">
                    </div>
                </label>
                <label>
                    <span class="inputbox-label"><?= $this->translate('Telephone'); ?></span>
                    <div class="order-inputbox-holder">
                        <input class="inputbox" type="text" name="shippingPhoneNumber" value="<?= $order->getCalculatedShippingPhoneNumber(); ?>">
                    </div>
                </label>
            </div>
            <div class="half" style="clear:both; padding-top:0px;">
                <label>
                    <input type="submit" name="save" class="button form-button address-button" value="<?= $this->translate('Save'); ?>">
                </label>
            </div>
        </form>
    </div>
</div>
<div id="product-payment-table" class="module clearfix section-separator">
    <span class="heading-large heading-spacing"><?= $this->translate('Product & Payment Information'); ?></span>
    <?php if(count($order->getItems())):?>
        <?= $this->productPaymentTable; ?>
    <?php else: ?>
        <p><?= $this->translate('This order has no items'); ?></p>
    <?php endif;?>
    <table class="no-borders">
        <tr>
            <td colspan="2" class="left">
                <?php if ($order->getPaymentMethod()): ?>
                    <?= $this->translate('Paid Via'); ?>: <strong><?= $order->getPaymentMethod() ?></strong>
                <?php endif; ?>
            </td>
            <td class="right"><strong><?= $this->translate('Postage'); ?>:</strong></td>
            <td class="right"><strong><?= $this->currencyFormat($order->getShippingPrice(), $order->getCurrencyCode()); ?></strong></td>
        </tr>
        <tr>
            <td colspan="2" class="left">
                <?php if ($order->getPaymentReference()): ?>
                    <?= $this->translate('Reference'); ?>: <strong><?= $order->getPaymentReference() ?></strong>
                <?php endif; ?>
            </td>
            <td class="right"><strong><?= $this->translate('Total'); ?>:</strong></td>
            <td class="right"><strong><?= $this->currencyFormat($order->getTotal(), $order->getCurrencyCode()); ?></strong></td>
        </tr>
    </table>
</div>
<div id="order-notes">
    <?= $this->notes ?>
</div>
